const $={apiKey:"AIzaSyB6AUBnK_7Vy2ABWI2JMo3ebG_Sljr8XlY",authDomain:"cyber-campus-2706f.firebaseapp.com",databaseURL:"https://cyber-campus-2706f-default-rtdb.firebaseio.com",projectId:"cyber-campus-2706f",storageBucket:"cyber-campus-2706f.appspot.com",messagingSenderId:"719410601264",appId:"1:719410601264:web:44fd2e3757721866303cf5",measurementId:"G-CEEFJP5LYZ"};firebase.initializeApp($);const d=firebase.database(),f=document,g=f.getElementById,h=g('loginForm'),i=g('loginContainer'),j=g('dashboardContainer'),k=g('salesForm'),l=g('salesTable'),m=g('totalSales'),n=g('averageSales'),o=g('userInfo'),p=g('toggleAnalysisButton'),q=g('toggleSalesButton'),r=g('analysisSection'),s=g('salesDetailsSection');let t,u,v=[],w=[],x={_1H:100,_2H:200,_3H:250,_1J:300,_3J:600,_7J:1200,_30J:4e3,_1G:100,_5G:400,_10G:700,_25G:1500,"_1H Pro":250,"_2H Pro":450,"_3H Pro":600,"_1J Pro":600,"_3J Pro":1200,"_7J Pro":2400,"_30J Pro":8e3};g('dateTime').value=new Date().toISOString().slice(0,16);h.addEventListener('submit',e=>{e.preventDefault();let a=g('username').value,b=g('password').value;d.ref('users/'+a).once('value').then(c=>{c.exists()?c.val().password===b?y(a):alert('Mot de passe incorrect'):d.ref('users/'+a).set({password:b}).then(()=>y(a)).catch(e=>{console.error('Error creating user:',e);alert('Erreur lors de la création du compte')})})});function y(a){u=a;i.style.display='none';j.style.display='block';o.textContent=`Utilisateur: ${a}`;z();A();B()}g('product').addEventListener('change',function(){let a=this.value;d.ref('sales/'+u).orderByChild('product').equalTo(a).limitToLast(1).once('value').then(b=>{if(b.exists()){let c=Object.values(b.val())[0];g('SI').value=c.SF||0}else g('SI').value=0});C()});g('V').addEventListener('input',D);g('APP').addEventListener('input',D);function D(){let a=parseInt(g('SI').value)||0,b=parseInt(g('APP').value)||0,c=parseInt(g('V').value)||0;g('SF').value=a+b-c}function C(){let a=g('product').value;g('PV').value=x[a]||0}k.addEventListener('submit',e=>{e.preventDefault();let a={dateTime:g('dateTime').value,product:g('product').value,SI:parseInt(g('SI').value)||0,APP:parseInt(g('APP').value)||0,V:parseInt(g('V').value)||0,SF:parseInt(g('SF').value)||0,PV:parseFloat(g('PV').value)||0};d.ref('sales/'+u).push(a).then(()=>{z();A();B();k.reset();g('dateTime').value=new Date().toISOString().slice(0,16)}).catch(b=>{console.error("Erreur lors de l'ajout de l'entrée :",b);alert("Une erreur est survenue lors de l'ajout de l'entrée.")})});function z(){let a=l.querySelector('tbody');a.innerHTML='';d.ref('sales/'+u).once('value').then(b=>{v=[];b.forEach(c=>{let e=c.val();e.total=(e.V*e.PV).toFixed(2);v.push(e)});E(v);F();G(l)})}function A(){let a={lite:g('stockTableLite'),daily:g('stockTableDaily'),proLite:g('stockTableProLite'),proDaily:g('stockTableProDaily'),data:g('stockTableData')};Object.values(a).forEach(b=>{b.querySelector('tbody').innerHTML=''});d.ref('sales/'+u).once('value').then(b=>{let c={};b.forEach(e=>{let f=e.val();if(!c[f.product]||new Date(f.dateTime)>new Date(c[f.product].dateTime))c[f.product]=f});Object.values(c).forEach(e=>{let f;if(['1H','2H','3H'].includes(e.product))f=a.lite;else if(['1J','3J','7J','30J'].includes(e.product))f=a.daily;else if(['1H Pro','2H Pro','3H Pro'].includes(e.product))f=a.proLite;else if(['1J Pro','3J Pro','7J Pro','30J Pro'].includes(e.product))f=a.proDaily;else if(['1G','5G','10G','25G'].includes(e.product))f=a.data;if(f){let g=f.querySelector('tbody').insertRow();g.insertCell(0).textContent=e.product;g.insertCell(1).textContent=e.SF;g.insertCell(2).textContent=new Date(e.dateTime).toLocaleString()}});Object.values(a).forEach(e=>{G(e)})})}function E(a){let b=l.querySelector('tbody');b.innerHTML='';a.forEach(c=>{let e=b.insertRow();e.insertCell(0).textContent=new Date(c.dateTime).toLocaleString();e.insertCell(1).textContent=c.product;e.insertCell(2).textContent=c.SI;e.insertCell(3).textContent=c.APP;e.insertCell(4).textContent=c.V;e.insertCell(5).textContent=c.SF;e.insertCell(6).textContent=c.PV;e.insertCell(7).textContent=c.total})}function F(){let a=f.querySelectorAll('#searchInputs input');a.forEach(b=>{b.addEventListener('input',()=>{let c=v.filter(e=>Object.keys(e).every(f=>{let g=g(`search${f.charAt(0).toUpperCase()+f.slice(1)}`)?.value.toLowerCase()||'';return e[f].toString().toLowerCase().includes(g)}));E(c);B(c)})})}function G(a){let b=a.querySelectorAll('th[data-sort]');b.forEach(c=>{c.addEventListener('click',()=>{let e=c.dataset.sort,f=a.id==='salesTable'?v:w;f.sort((g,h)=>{if(g[e]<h[e])return-1;if(g[e]>h[e])return 1;return 0});a.id==='salesTable'?(E(f),B(f)):H(f,a)})})}function H(a,b){let c=b.querySelector('tbody');c.innerHTML='';a.forEach(e=>{let f=c.insertRow();f.insertCell(0).textContent=e.product;f.insertCell(1).textContent=e.SF;f.insertCell(2).textContent=new Date(e.dateTime).toLocaleString()})}function B(a=v){let b=0,c=0,e={labels:[],sales:[],prices:[]};a.forEach(f=>{b+=f.V*f.PV;c++;e.labels.push(new Date(f.dateTime).toLocaleString());e.sales.push(f.V);e.prices.push(f.PV)});let d=b/c||0;m.textContent=`Total des ventes: ${b.toFixed(2)} FCFA`;n.textContent=`Moyenne des ventes par jour: ${d.toFixed(2)} FCFA`;I(e);J(a)}function I(a){let b=g('salesChart').getContext('2d');if(t)t.destroy();t=new Chart(b,{type:'line',data:{labels:a.labels,datasets:[{label:'Ventes',data:a.sales,borderColor:'rgb(0, 255, 255)',tension:0.1},{label:'Prix de vente',data:a.prices,borderColor:'rgb(255, 99, 132)',tension:0.1}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,grid:{color:'rgba(255, 255, 255, 0.1)'},ticks:{color:'rgb(0, 255, 255)'}},x:{grid:{color:'rgba(255, 255, 255, 0.1)'},ticks:{color:'rgb(0, 255, 255)'}}},plugins:{legend:{labels:{color:'rgb(0, 255, 255)'}}}}});function J(a){let b=new Date(),c=new Date(b.getTime()-7*24*60*60*1e3),d=new Date(b.getTime()-30*24*60*60*1e3),e=new Date(b.getTime()-90*24*60*60*1e3),f=a.filter(h=>new Date(h.dateTime)>=c),i=a.filter(h=>new Date(h.dateTime)>=d),j=a.filter(h=>new Date(h.dateTime)>=e);K(f,'week');K(i,'month');K(j,'threeMonth')}function K(a,b){let c=a.reduce((e,f)=>e+f.V*f.PV,0),d=c/a.length||0;g(`${b}TotalSales`).textContent=`Total des ventes: ${c.toFixed(2)} FCFA`;g(`${b}AverageSales`).textContent=`Moyenne des ventes par jour: ${d.toFixed(2)} FCFA`}p.addEventListener('click',function(){if(r.style.display==='none'||r.style.display===''){r.style.display='block';s.style.display='none';this.textContent='Masquer l\'analyse des ventes';q.textContent='Détail des ventes'}else{r.style.display='none';this.textContent='Analyse des ventes'}});q.addEventListener('click',function(){if(s.style.display==='none'||s.style.display===''){s.style.display='block';r.style.display='none';this.textContent='Masquer le détail des ventes';p.textContent='Analyse des ventes'}else{s.style.display='none';this.textContent='Détail des ventes'}});const L=g('theme-toggle'),M=f.documentElement;let N=!0;function O(a){if(a){M.classList.remove('light-theme');L.textContent='🌙';L.setAttribute('aria-label','Activer le mode clair')}else{M.classList.add('light-theme');L.textContent='☀️';L.setAttribute('aria-label','Activer le mode sombre')}N=a}L.addEventListener('click',()=>{O(!N)});g('filterStockDates').addEventListener('click',function(){let a=new Date(g('stockStartDate').value),b=new Date(g('stockEndDate').value);P(a,b)});g('filterSalesDates').addEventListener('click',function(){let a=new Date(g('salesStartDate').value),b=new Date(g('salesEndDate').value),c=v.filter(d=>{let e=new Date(d.dateTime);return(!a||e>=a)&&(!b||e<=b)});E(c);B(c)});function P(a,b){let c={lite:g('stockTableLite'),daily:g('stockTableDaily'),proLite:g('stockTableProLite'),proDaily:g('stockTableProDaily'),data:g('stockTableData')};Object.values(c).forEach(d=>{d.querySelector('tbody').innerHTML=''});d.ref('sales/'+u).once('value').then(d=>{let e={};d.forEach(f=>{let h=f.val(),i=new Date(h.dateTime);if((!a||i>=a)&&(!b||i<=b)){if(!e[h.product]||i>new Date(e[h.product].dateTime))e[h.product]=h}});Object.values(e).forEach(f=>{let h;if(['1H','2H','3H'].includes(f.product))h=c.lite;else if(['1J','3J','7J','30J'].includes(f.product))h=c.daily;else if(['1H Pro','2H Pro','3H Pro'].includes(f.product))h=c.proLite;else if(['1J Pro','3J Pro','7J Pro','30J Pro'].includes(f.product))h=c.proDaily;else if(['1G','5G','10G','25G'].includes(f.product))h=c.data;if(h){let i=h.querySelector('tbody').insertRow();i.insertCell(0).textContent=f.product;i.insertCell(1).textContent=f.SF;i.insertCell(2).textContent=new Date(f.dateTime).toLocaleString()}});Object.values(c).forEach(f=>{G(f)})})}z();A();r.style.display='none';s.style.display='none';z();A();B();let Q=localStorage.getItem('darkTheme');if(Q!==null)O(Q==='true')}
